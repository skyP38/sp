# StereoBM - GIMP Plugin for Stereo Block Matching

## Описание

**StereoBM** - это плагин для графического редактора GIMP, который реализует алгоритм Stereo Block Matching для вычисления карты диспаратности из стереоизображений формата side-by-side. Плагин использует метод SAD (Sum of Absolute Differences) для поиска соответствий между левым и правым изображениями.

## Технические детали

### Архитектура проекта

Проект состоит из следующих файлов:

1. **stereobm.h** - заголовочный файл с объявлениями структур и функций
2. **stereobm_main.c** - основной файл плагина GIMP (регистрация, инициализация)
3. **stereobm_plugin.c** - основная логика обработки изображения
4. **stereobm_compute.c** - вычислительный модуль алгоритма StereoBM
5. **stereobm_dialog.c** - диалоговое окно параметров
6. **open.py** - Python-скрипт для сравнения с реализацией OpenCV

### Алгоритм работы

1. **Загрузка изображения**: Плагин ожидает side-by-side стереоизображение (четная ширина)
2. **Предварительная обработка**:
   - Разделение на левое и правое изображения
   - Конвертация в градации серого
   - Применение фильтра Собеля для усиления границ
3. **Stereo Block Matching**:
   - Для каждого пикселя левого изображения выполняется поиск соответствия в правом
   - Используется окно сравнения заданного размера (block_size)
   - Рассчитывается SAD (сумма абсолютных разностей) для каждого уровня диспаратности
4. **Постобработка**:
   - Проверка уникальности соответствий
   - Отсечение слаботекстурированных областей
   - Нормализация и цветное кодирование результата

### Параметры алгоритма

| Параметр | Описание | Диапазон | По умолчанию |
|----------|----------|----------|--------------|
| **Num Disparities** | Количество уровней диспаратности | 16-256 (кратно 16) | 64 |
| **Block Size** | Размер блока для сравнения | 3-21 (нечетные) | 15 |
| **Pre Filter Cap** | Предел для предварительной фильтрации | 1-63 | 31 |
| **Texture Threshold** | Порог текстуры (отсечение слабых текстур) | 0-1000 | 10 |
| **Uniqueness Ratio** | Коэффициент уникальности соответствия (%) | 0-100 | 15 |

## Сборка и установка

### Системные требования:
- GIMP версии 3.0+
- GTK4
- GEGL 0.4
- Компилятор GCC

### Инструкция по сборке

```bash
# Сборка плагина
make

# Сборка и установка плагина
make install

# Очистка сборочных файлов
make clean
```

### Установка в GIMP:

1. Откройте side-by-side стереоизображение в GIMP
2. Перейдите в меню: **Filters → Stereo BM**
3. Настройте параметры в диалоговом окне
4. Нажмите **OK** для вычисления карты диспаратности

### Python-скрипт для сравнения

Для сравнения с реализацией OpenCV используйте скрипт `open.py`:

```bash
python open.py путь_к_стереоизображению.jpg
```

## Теория

### Stereo Block Matching

Алгоритм StereoBM основан на поиске соответствий между двумя изображениями стереопары. Для каждого пикселя левого изображения выполняется поиск наиболее похожего пикселя в правом изображении в пределах заданного диапазона диспаратностей.

### SAD (Sum of Absolute Differences)

Метрика SAD рассчитывается по формуле:

\[
SAD(x, y, d) = \sum_{i=-k}^{k}\sum_{j=-k}^{k} |I_L(x+i, y+j) - I_R(x+i-d, y+j)|
\]

где:
- \(I_L\) - левое изображение
- \(I_R\) - правое изображение
- \(d\) - текущая диспаратность
- \(k\) - половина размера блока

### Цветное кодирование результата

Карта диспаратности кодируется цветовой шкалой:
- **Синий → Голубой** (ближние объекты)
- **Зеленый → Желтый** (средняя дистанция)
- **Красный** (дальние объекты)

## Сравнение с OpenCV

### Сходства

1. Использование предварительного фильтра Собеля
2. Параметризация алгоритма (block_size, num_disparities, etc.)
3. Метод SAD для сравнения блоков
4. Проверка уникальности соответствий

### Отличия

| Особенность | Плагин | OpenCV StereoBM |
|-------------|------------|-----------------|
| **Тип приложения** | GIMP Plugin | Библиотека C++ |
| **Поддержка цветов** | Только градации серого | Только градации серого |
| **Субпиксельная точность** | Да (×16) | Да |
| **Фильтрация пятен** | Нет | Да |
| **Многопоточность** | Нет | Да |